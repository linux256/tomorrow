\newpage

## OPERATE RUNNING SYSTEMS
# 18. Interrupt the boot process in order to gain access to a system

---

### I. SECUENCIA DE ARRANQUE

1. **POWER ON** El firmware, BIOS o UEFI, ejecutan POST (PowerOnSelfTest)

>

2. **BOOTABLE** Selección del dispositivo desde el que iniciar (bootable)

>

3. **BOOTLOADER** Se carga el bootloader (GRUB) del dispositivo bootable. Aquí
se dispone del GRUB prompt. Grub lo instalan `grub2-install` y `grub2-mkconfig`.
Por error el inicio puede detenerse en:

> * `GRUB` no es un prompt, indica GRUB dañado, solo cabe reconstruirlo

> * `grub rescue>` trabajar desde este prompt cargando módulos (`insmod normal`)
da posibilidades tempranas de reparación o de terminar un arranque

> * `grub>`

>

4. **KERNEL+INITRAMFS** Se carga el Kernel y se carga Initramfs (que contiene
drivers+scripts). Se emplea `/etc/dracut.conf` y `/etc/dracut.conf.d/`

>

5. **INIT DESDE INITRAMFS** Se ejecuta el proceso `/sbin/init` (systemd) desde
initramfs y se carga systemd-udevd. Se puede detener el arranque en esta etapa
con el argumento **`rd.break`** para el kernel

>

6. **INITRD.TARGET** El filesystem de disco se monta en `/sysroot/` por `dracut`

>

7. **MOUNT /**. El filesystem en disco se monta en `/` y se carga `systemd` de
disco. Se emplea `/etc/fstab/` para montar los sistemas de ficheros. Se puede
detener en este paso y no cargar `systemd` con el parámetro del kernel en GRUB
**`init=/bin/bash`** (habrá que remontar / en `rw` para trabajar, aplicar
contexto SELinux y cambiarse a `systemd` para reiniciar)

>

8. **DEFAULT.TARGET** Se ejecuta `default.target` y se termina en Login. Se
puede modificar este target con `systemctl set-default` y proporcionando el
argumento de arranque al kernel `systemd.unit=rescue.target`


### II. COMANDOS UTILES SOBRE GRUB

**`grubby --info=ALL`**

> Detalla los parametros de arranque de todas las opciones de GRUB, incluyendo:
kernel, dispositivo raíz, argumentos del kernel, initramfs, título, id e índice.

**`grub2-reboot 1`**

> Marca que en el siguiente reinicio se elija la opción 1. Muy útil para evitar
errores de selección en el siguiente inicio

`grub2-editenv list`

> Proporciona informacion del arranque de GRUB, opcion por defecto, función
> de *auto-hide*, si el arranque actual fue exito y proxima entrada prevista

`grub2-editenv - unset menu_auto_hide`

> Deshabilita la funcionalidad de *auto-hide* del menu de GRUB

### III. RESETTING THE ROOT PASSWORD [EX200] 

>

***Procedimiento para restablecer la contraseña de root***

>

**`init=/bin/bash/`**

> entrar en GRUB, `e` para añadir el parámetro al kernel, arrancar con `CTRL-x`

**`mount -o remount,rw /`**

> remontar el sistema raíz en modo lectura y escritura

**`passwd`**

> cambiar la contraseña del usuario `root`

**`touch /.autorelabel`**

> restablecer contexto del filesystem en el siguiente inicio

**`exec /usr/lib/systemd/systemd`**

> se reemplaza el shell `bash` en ejecución por `systemd` y reinicia la máquina

>

### IV. DEVICE.MAP

`/boot/grub2/device.map`

> Fichero que contiene como GRUB localiza los discos en su arranque. Se debe
> conocer y mantener una copia para facilitar el uso de `grub rescue>` de ser
> necesario.

> Contenido de `/boot/grub2/device.map/` en una máquina KVM:

> `# this device map was generated by anaconda`

> `(hd0)      /dev/vda`


---

*Referencias:*

* https://hansdegoede.livejournal.com/19081.html
* http://aty.sdsu.edu/bibliog/latex/debian/grub2rescue.html
* https://www.linuxfoundation.org/blog/blog/classic-sysadmin-how-to-rescue-a-non-booting-grub-2-on-linux
* https://www.gnu.org/software/grub/manual/grub/grub.html#GRUB-only-offers-a-rescue-shell


