\newpage

## CREATE AND CONFIGURE FILESYSTEMS
# 36. Create and configure set-GID directories for collaboration

---

### I. BITS DE ACCESO ESPECIAL [EX200]

**user + s(special)** -- SUID (Set User IDentity) 4xxx. El proceso se ejecuta
con el UID efectivo que corresponda al propietario del fichero. El UID real del
proceso sigue siendo el usuario que lo ejecuta, quien crea el proceso, y que
mantiene permisos para suspender y matar el proceso.

Si el fichero era ejecutable para el propietario, la `x` aparece como `s` en la
parte de usuario. Si el fichero no era ejecutable, aparecerá como `S`. *En
directorios no tiene efecto estándar*

>

**group + s(special)** -- SGID (Set Group IDentity) 2xxx. En un fichero, hace
que el proceso se ejecute con el GID efectivo del grupo propietario.

Aplicado a un directorio, hace que su grupo propietario sea también el grupo
 propietario por defecto para todos los nuevos ficheros y directorios que se
creen. Si el fichero (directorio) tenía permiso de ejecución, aparece como `s`
en otro caso aparece como `S`

>

**other + t(sticky)** -- STICKY BIT 1xxx. Se aplica a nivel de directorio,
logrando que los ficheros contenidos en el directorio solo los puedan eliminar
3 entidades:

1. `root`
2. el propietario del fichero
3. el propietario del directorio donde se encuentra el fichero

Si el directorio era ejecutable para otros, aparecerá como `t`. En otro caso
aparecerá como `T`. *Aplicado a ficheros individuales, no tiene efecto*

>

**Aplicación de los bits de permisos especiales**

* `chmod u+s   ficher` aplica SUID a `ficher`
* `chmod +4000 ficher` aplica SUID a `ficher`

>

* `chmod g+s   ficher` aplica SGID a `ficher`
* `chmod g+s   direct` aplica SGID a `direct`
* `chmod +2000 ficher` aplica SGID a `ficher` (idem con `direct`)

>

* `chmod o+t   direct` aplica STICKY BIT a `direct`
* `chmod +1000 direct` aplica STICKY BIT a `direct`

`chmod  [u|g|o|a]+|-|=[r|w|x|X|s|t]  fichero|directorio`

> Forma general de añadir (`+`), retirar (`-`) o establece exactamente (`=`) un
permiso al usuario propietario (`u`), al grupo propietario (`g`), a otros (`o`)
o a todas las entidades (`a` o nada), de lectura (`r`), escritura (`w`),
ejecución (`x`), especial (`s`) o sticky bit (`t`)

>

### II. ATRIBUTOS EXTENDIDOS

`man chattr` 

> Ayuda sobre atributos extendidos, cuya aplicación dependerá de lo que el 
> sistema de ficheros tenga aplicado

`lsattr  fichero`

> Lista los atributos extendidos de `fichero`

`chattr  +|-atributo  fichero` 

> Aplica o retira a fichero los siguientes atributos,

* `A` no modificar ACCESS TIME en cada acceso para mejorar el rendimiento
* `a` se puede añadir al fichero, pero no se puede eliminar, solo lo abre en
modo *append*
* `c` comprimir el fichero si el volumen lo permite
* `D` los cambios se escriben inmediatamente, NO CACHEAR
* `d` excluir este fichero de copias de seguridad realizadas con `dump`
* `I` habilita INDEXAR el directorio
* **`i` fichero INMUTABLE, no se puede hacer ningún cambio**. *Ni `root` puede
borrarlo mientras tenga este atributo aplicado*
* `s` sobreescribe con 0 los bloques que ocupara el fichero al borrarlo
* `u` guardar información para recuperarlo (undelete)


### III. COMPARTICION DE UN DIRECTORIO PARA LECTURA Y ESCRITURA [EX200]

**1. Creación de usuarios que pertenecen al grupo `migrupo` con acceso
compartido a `/shared`**

*Se parte de permisos por defecto: 755 para directorios y 644 para ficheros*

> `# useradd user1; passwd user1`  
> `# useradd user2; passwd user2`  
> `# groupadd migrupo`  
> `# usermod -aG migrupo user1`  
> `# usermod -aG migrupo user2`  

**2. Creación de la carpeta y establecimiento del grupo propietario**

> `# mkdir /shared`  
> `# chown root:migrupo /shared`

*En este punto user1 y user2 pueden leer ficheros pero no crear ni borrar*

**3. Permisos para crear y borrar ficheros**

> `# chmod g+w /shared`

*En este punto user1 y user2 pueden leer, crear y borrar ficheros, pero no
modificar fichero del otro usuario*

**4. Establecimiento de SGID para que los ficheros creados tengan como grupo
propietario al grupo de usuarios**

> `# chmod g+s /shared`  

> `(user1)$ touch fichero1`  
> `(user2)$ touch fichero2` 

*En este punto user1 y user2 pueden leer, crear y borrar ficheros, pero siguen
sin poder modificar documentos de otro usuario, a no ser que su propietario de
permisos g+w expresamente al fichero que quiera compartir*

**5a. Opción 1: compartir para escritura ficheros individualmente**

> `(user1)$ chmod g+w fichero1`  
> `(user2)$ chmod g+w fichero2` 

*En este punto user1 y user2 pueden leer, crear, borrar y modificar los
ficheros sobre los que el otro usuario les haya dado permiso*

**5b. Opción 2: compartir para escritura ficheros por defecto**

> `# setfacl -d -m group::rw /shared`

*Otra posibilidad mas eficiente con `setfacl`, es que por defecto (`-d `) se
modifiquen (`-m`)  los permisos para que el grupo propietario (`group::`)
tenga permisos de lectura y escritura (`rw`) en `/shared`*

**6. Imposibilitar borrado de ficheros de otros miembros del grupo**

> `# chmod o+t /shared`

*En este punto user1 y user2 pueden leer, crear, borrar y modificar los
ficheros sobre los que el otro usuario les haya dado permiso, y solo pueden
borrar los ficheros de los que son propietarios*

*El empleo de sticky bit, puede tener mas sentido cuando los ficheros no se
comparten para escritura: si se comparten para escritura se pueden dejar vacíos,
y evitar que se puedan eliminar podría no tener sentido. Es decir que el empleo
de 'sticky bit' parece mas orientado a cuando `/shared` se usa para que los
usuarios de un grupo pueden añadir ficheros que se compartan para solo lectura;
es decir sin ejecutar 5a ni 5b. En este caso de uso, aplicar SGID no tiene
sentido porque los nuevos ficheros se crean con 644 lo que ya permite que todos
puedan leer cualquier fichero.*

**Restricción de acceso a otros**
*En el paso 3 se puede restringir el acceso a Otros con `chmod 770 /shared` de
manera que solo los miembros de `migrupo` puedan leer y cambiarse al directorio
`shared`, limitando el acceso a la carpeta compartida.*


