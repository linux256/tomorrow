\newpage

## OPERATE RUNNING SYSTEMS
# 23. Preserve system journals

---

### I. CONFIGURACION DE LA PERSISTENCIA DEL JOURNAL [EX200]


`/etc/systemd/journald.conf`

> Fichero de configuración principal del servicio `systemd-journald` donde se
> define la persistencia,

* **`Storage=auto`** escribe el journal en `/var/log/journal/` *si el directorio
existe*
* **`Storage=volatile`** escribe en `/run/log/journal/`
* **`Storage=persistent`** crea `/var/log/journal/` si no existe
* **`Storage=none`** no almacena el *journal* ni en *runtime* pero mantiene el
*forwarding* a kernel log o a syslog

`man journald.conf`

> Ayuda del fichero de configuración `/etc/systemd/journald.conf`

>

**Proceso recomendado para establecer journal persistente [EX200]**

`mkdir /var/log/journal/`

> Se crea el directorio para que aplique `Storage=auto`

`chown root:systemd-journal /var/log/journal/`

> Se cambia el grupo propietario del directorio

`chmod 2755 /var/log/journal/`

> Se establece SGID=1 para que los ficheros creados mantengan el *owner group*

`systemctl restart systemd-journal-flush`

> Se reinicia el servicio que vuelca a disco el *journal*

### II. PARAMETROS DEL JOURNAL

Los parámetros de rotación se definen en `/etc/systemd/journald.conf`,

* **`SystemMaxUse`** uso máximo del *journal* persistente, por defecto 10%
* **`SystemKeepFree`** mínimo espacio libre que debe existir en disco, p.d. 15%
* **`SystemMaxFileSize`** tamaño máximo del *journal* por defecto 4GB
* **`MaxFileSec`** tiempo máximo de los registros a conservar, p.d. 1 mes. Si se
pone a 0 se deshabilita
* **`RuntimeMaxUse`** uso máximo del *journal runtime* (`/run/log/journal`),
por defecto 10%
* **`RuntimeKeepFree`** mínimo espacio libre en disco, p.d. 15%
* **`RuntimeMaxFileSize`** tamaño máximo del *journal runtime* por defecto 4GB

**`journalctl | grep -E "Runtime Journal|System Journal"`**

> Muestra tamaño ocupado y disponible

### III. LOGROTATE

`man logrotate`

> Ayuda del servicio de rotación de `syslog`

`/etc/logrotate.conf`

> Fichero de configuración general de parámetros de rotación y de borrado de
> *backlogs*. Cuando un log se rota, el fichero de log se renombra y pasa a ser
> un fichero de *backlog*. Tendrá normalmente un periodo de rotación (`Weekly`)
> y un periodo de borrado de *backlogs* (`rotate 4`); en este caso se dispone de
> 5 semanas de logs, el actual y 4 *backlogs*

`/etc/logrotate.d/`

> Fichero de configuración que sobreescribe `/etc/logrotate.conf`


