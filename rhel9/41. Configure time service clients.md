\newpage

## DEPLOY CONFIGURE AND MAINTAIN SYSTEMS
# 41. Configure time service clients

---

### I. RELOJES DEL SISTEMA: HARDWARE CLOCK, SYSTEM CLOCK, LOCAL TIME

En Linux se distinguen tres tipos de relojes o de hora,

* **Hardware clock** o **Real Time Clock (RTC)**, conocida como *Hardware Time*.
Debe estar en UTC y depende de una batería en la placa base del equipo. Coincide
con la hora inicial del sistema en el arranque

* **Operating System Clock** o **System Clock**, conocida como *System Time*.
En el arranque del s.o. se inicializa a *hardware time* y una vez que el s.o. ha 
arrancado es independiente del *hardware clock*. Emplea circuitos de reloj de la
CP, mucho más preciso que el reloj de la placa base. Debe estar en UTC.

* **Local Time**, es una hora convertida desde el *system time* aplicando el
offset de una zona horaria lo que incluye la correccioń DST (daylight savetime).

>

### II. NETWORK TIME PROTOCOL, NTP

Protocolo para sincronizar la hora consultando a través de Internet a servidores
de hora, categorizados en *stratum* que indican su fiabilidad, siendo un menor
*stratum* mas fiable que un mayor *stratum*. Son asignaciones habituales,

* Internet Time Servers, *stratum = 1 ó 2*, de máxima fiabilidad
* Local Time Servers con buen Hardware Clock, *stratum = 5*
* Local Time Servers con Hardware Clock normal, *stratum = 8*
* Local clock, local system, *stratum = 10*
* asignar *stratum = 15* cuando no se debe usar un equipo para sincronizar hora

>

### III. COMANDOS DATE (SYSTEM TIME) Y HWCLOCK (HARDWARE TIME)

`date +%d-%-%y`  
`date '+%F %T'`

> Muestra la *system time*  ajustando el formato de salida. En el segundo caso
fecha y hora completa

`date --date '@1420987251'`

> Convierte hora epoch (segundos transcurridos desde 1-1-1970 UTC) a humano

`date -s 16:03`

> Establece la hora del *system time*

`hwclock --systohc`

> Emplea *system time* para establecer la *hardware time*

`hwclock --hctosys`

> Emplea *hardware time* para establecer la *system time*
 

### IV. SERVICIO CHRONY: TIMEDATECTL

`dnf install chrony -y && systemctl enable --now chronyd`

> Instala, habilita e inicia el servicio `chronyd`

`timedatectl set-ntp 1`

> Es necesario habilitar el ajuste NTP de `chronyd` para gestionar *system time
y hardware time*

**`chronyc sources`**

> Ejecutado en un cliente NTP, muestra información de su sincronización

`/etc/chrony.conf`

> Fichero de configuracion con servidores NTP empleados por **chronyd**. Serán
configuracines típicas,

> * **Servidor** (precisa `systemctl restart chronyd`)  
> `allow 192.168.0.0/24    #permitir clientes de red ...`  
> `local stratum 8`  
> * **Cliente** (precisa `systemctl restart chronyd`)  
> `#pool  2.rhel.pool.ntp.org`  
> `server  miservidor.exanple.com`  

`timedatectl`

> Comando de referencia para gestionar la hora, con comandos habituales,

> * `timedatectl set-ntp 0` desactiva ajuste NTP de la hora usando **chronyd**
> * `timedatectl set-ntp 1` activa ajuste NTP de la hora usando **chronyd**
> * `timedatectl status` muestra estado de hora hw, de sistema, timezone y NTP
> * `timedatectl show` misma información que comando actual, en formato máquina
> * `timedatectl set-time TIME` establece *system time* y *hardware time*
> * `timedatectl set-local-rtc 0` fija que *hardware time* es UTC o local (`1`)

>

### V. TIMEZONES

**Método 1**. Empleando `timedatectl`

`timedatectl list-timezone`

> Lista las zonas horarias

`timedatectl set-timezone ZONE`

> Establece la zona horaria del sistema

>

**Método 2**. Asistente

`tzselect`

> Asistente que permite seleccionar y establecer una hora

>

**Método 3**. Creando un enlace simbólico `/etc/localtime` a la zona deseada

`ln -sf /usr/share/zoneinfo/Europe/Madrid   /etc/localtime`  
`restorecon -Rv /etc`  

> Crea enlace y restablece el contexto SELinux para que no falle


