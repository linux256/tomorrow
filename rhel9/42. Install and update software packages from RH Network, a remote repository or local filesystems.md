\newpage

## DEPLOY CONFIGURE AND MAINTAIN SYSTEMS
# 42. INSTALL AND UPDATE SOFTWARE PACKAGES FROM
# RH NETWORK, A REMOTE REPOSITORY OR LOCAL
# FILESYSTEMS


---

### I. SUBSCRIPCIONES A RH NETWORK

`subscription-manager  register`

> Registra el sistema en el servidio de gestión de suscripciones debiendo dar un
nombre de usuario y clave del cliente. Quedan almacenados los certificados de la
RH ACCOUNT en *`/etc/pki/consumer*`

`subscription-manager  list --available`

> Muestra la suscriciones disponibles para la RH ACCOUNT registrada

`subscription-manager  list --consumed`

> Muestra las suscripciones usadas para la RH ACCOUNT

**`subscription-manager  attach --auto`**

> Aplica una subscripcion al sistema de manera automática. Esto permite conectar
> los repositorios disponibles de la suscripción, registrandolo en
*`/etc/pki/entitlement`*. Se podrán también instalar productos de RH registrando
los certificados de los productos instalados en *`/etc/pki/product`*.

`subscription-manager  unregister`

> Quita la subscripcioń aplicada al sistema, que pasa a estar disponible para
otros sistemas y elimina la identidad del cliente registrada en el sistema

>

### II. DEFINIR Y EMPLEAR UN REPOSITORIO LOCAL [EX200]

`mkdir /repo`  
`echo "/dev/sr0   /repo   iso9660  defaults  0 0" >> /etc/fstab`  
`echo "$(blkid /dev/sr0|awk {print $2})  /repo  iso9660  defaults  0 0" >>...`  
`mount -a`  

> Crea directorio y entrada para el montaje automático del CD con la ISO de 
instalacion de RHEL.

**Opción 1. Creación mediante `dnf config-manager`**

**`dnf config-manager  --add-repo=file:///repo/BaseOS`**

> Añade repositorio BaseOS montado en el directorio `/repo/BaseOS/`

**`dnf config-manager  --add-repo=file:///repo/AppStream`**

> Añade repositorio AppStream montado en el directorio `/repo/AppStream/`

**`dnf config-manager  --save  --setopt=repo_`\*`.gpgcheck=0`**

> Añade a todos los repositorios con nombre "repo_BaseOS" y "repo_AppStream" la
> opción `gpgcheck=0` y guarda el resultado. Esto puede añadirse a mano en los
> ficheros de los repositorios.

**`dnf repolist -v`**

> Muestra los repositorios disponibles para `dnf`, detallando información `-v`

**`dnf makecache`**

> Actualiza la cache de metadatos de los repositorios

Con esto se logra crear con `dnf config-manager` un fichero de descripción de
los repositorios añadidos.
*Nota: Con `LANG=es.UTF-8` no se encuentra el comando `dnf config-manager`. Es
necesario cambiar a LANG=en_US.UTF-8*

>

**Opción 2. Creación manual de repositorios locales**

Se parte de un conjunto de ficheros \*`.rpm` y de tener instalado `createrepo`.
Se crea el fichero de descripción del repositorio,

> `vi /etc/yum.repos.d/mirep.repo`  
> 
> `[mirep]`  
> `name=repositorio local creado manualmente`  
> `baseurl=file:///rutarepo`  
> `gpgcheck=no`  
> `enabled=yes`  
> `mirrorlist=...  #omitir si no hay mirror`  
> `gpgkey=...      #omitir si no hay firma GPG del repositorio`  

A continuación se genera un fichero `.xml` con los metadatos de los ficheros
\*`.rpm`. *En el caso de emplear los directorios `BaseOS` o `AppStream` del DVD
de instalacion de RHEL no es necesario crear metadatos por que ya vienen en los
directorios*

> `createrepo /rutarepo    #(necesita tener previamente instalado createrepo)`

### III. DNF

**Paso 1. Comandos de búsqueda de información**

`dnf makecache`

> Descarga y actualiza metadatos de los repositorios. Importante antes de buscar
o de instalar ningún paquete nuevo.

`dnf search  zlib`

> Busca paquetes que contengan "zlib" en `nombre` y en `summary`

`dnf search all  zlib`

> Busca paquetes con "zlib" en `nombre`, `summary`, en `description` y en `URL`

`dnf provides  unzip`  
`dnf whatprovides unzip`  

> Busca paquetes en el siguiente orden, (1) que proporcionen el fichero `unzip`
con ese full-path, (2) con el nombre `unzip` y (3) suponiendo que es un comando
de sistema para lo que antepone las rutas `/usr/bin, /usr/sbin, /bin, /sbin`.  
El comando `whatprovides` es un alias de `provides`.


`dnf provides  /usr/bin/unzip`  
**`dnf provides` \*`/unzip`**

> Busca paquetes que proporcionen ficheros con nombre exacto `/usr/bin/unzip/`.
Admite el empleo de *wildcards* en la ruta, lo que facilita las busquedas

`dnf info httpd mariadb`

> Información de uno o varios paquetes; puede ampliarse con `-v`

**Paso 2. Instalar el paquete**

`dnf install`

> Instala el paquete

`dnf remove`

> Elimina el paquete

`dnf list [all|--all]`

> Lista todos los paquetes disponibles en todos los repositorios. La opcion 
`all` es por defecto

`dnf list installed`

> Lista todos los paquetes instalados, también puede escribirse `--installed`

**`dnf list upgrades`**

> Lista todos los paquetes instalados que se pueden actualizar. No fuerza una
sincronizacion de la cache, por lo que es conveniente hacer antes `makecache`

**`dnf upgrade`**

> Actualiza paquetes instalados reemplazando las versiones antiguas, salvo en
los paquetes del `kernel` donde no se reemplaza, sino que se añade. El comando
`update` es un alias obsoleto

***Instalación de Grupos***

`dnf group list`

> Lista grupos disponibles. Un grupo es un conjunto de paquetes que proporciona
en conjunto una funcionalidad o rol determinado

`dnf group list installed`

> Lista grupos instalados

`dnf group list installed hidden`

> Lista grupos instalados incluso los *ocultos*

`dnf group info "Container Management"`

> Muestra informacion del grupo y que paquetes contiene

`dnf group install  "Virtualization Host"`

> Instala el rol indicado

**Paso 3. Limpieza**

`dnf clean all`

> Borra todos los ficheros cacheados de metadatos de repositorios, los metadatos
de los repositorios y los paquetes cacheados del sistema.

### IV. DNF HISTORY

`dnf history`

> Histórico de transacciones realizadas por DNF

`dnf history list  unzip`

> Muestra en que transacciones participo el paquete `unzip`

`dnf history info 27`

> Muestra detalle de la transacción con ID=27

`dnf history undo  27`

> Deshace la transacción 27

`dnf history rollback 27`

> Desinstala desde la transaccion 28 en adelante, regresando a que la última
transacción ejecutada sea la 27

### V. DNF MODULES

`dnf module list`

> Lista todos las versiones (*streams*) de módulos disponibles, con sus perfiles
(*profiles*). Un módulo siempre está vinculado a una versión. Los perfiles son
conjuntos de paquetes para un uso específico.

`dnf module list installed`

> Lista las versiones de módulos, que tengan perfiles instalados.

`dnf module info php:8.1`

> Muestra información del *stream* 8.1 del módulo `php`

**`dnf module enable php:8.1`**

> Habilita el *stream* 8.1 del módulo `php`

`dnf module install php`

> Instala la versión habilitada del módulo `php`. Si no se ha habilitado de
manera expresa ninguna version, instala el *stream* por defecto

`dnf module install php:8.2`

> Deshabilita *stream* 8.1, y habilita e instala *stream* 8.2 del módulo `php`

`dnf distro-sync`

> Actualiza todos los paquetes dependientes que no se encuentran en el propio
módulo


### VI. PAQUETES RPM: INSTALACION Y CONSULTA

*Los paquetes RPM (Red Hat Package Manager) tienen la sintáxis,* 
 
> `nombre-version-subversion.redhatversion.arquitectura  ---
autofs-5.01.72-40.el7.x86-64`

`dnf install paquetedescargado`

> Instala el paquete descargado, comprobando sus dependencias

`rpm -ivh paquetedescargado`

> Instala el paquete con sus dependencias, lo marca como correcto (`-h`) y
muestra mensajes (`-v`)

`rpm -Uvh paquete`

> Realiza Upgrade del paquete

`rpm -evh paquete`

> Desinstala el paquete

`rpm -q...`

> Consulta información sobre/de los paquetes,

* `-qa` , lista todos los paquetes instalados
* `-qi paq` , información del paquete indicado
* **`-ql paq` , lista los ficheros del paquete**
* **`-qf fic` , de que paquete procede el fichero `fic` (inverso de `-ql`)**
* `-qd paq` , lista la documentación del paquete
* `-qc paq` , lista los ficheros de configuración del paquete
* `-qR paq` , muestra las dependencias de un paquete
* `-qp --scripts paq` , consulta a `paq` (`-p`), NO a la base de datos rpm, por
los scripts de `paq`


`rpm -V paquete` revisa si ha cambiado algún fichero desde la instalación de
`paquete`

`rpm -Va` revisa todos los paquetes

>

`dnf install dnf-utils yum-utils`

* Instala `repoquery` (de `dnf-utils`), para consultar un paquete desde su
repositorio sin descargarlo
* Instala `yumdownloader` (de `yum-utils`), para descargar un paquete


