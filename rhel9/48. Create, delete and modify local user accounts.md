\newpage

## MANAGE USERS AND GROUPS
# 48. Create, delete and modify local user accounts

---

### I. FICHEROS DE USUARIOS Y GRUPOS [EX200]

`/etc/passwd`

> Fichero definición de usuarios, con el contenido (`man 5 passwd`):

> `usuario:x:UID:GID:gecos:home:shell`

> Se puede editar con `vipw` pero NO se recomienda editarlo directamente

>

`/etd/shadow`

> Fichero con informacion de la contraseña y sus edades, con el contenido (`man
5 shadow`):

> `login:encryptedpasswd:dateLastChange:minAge:maxAge:warningPeriod:inacPeriod:
accountExpirationDate:reserved`

> Se puede editar con `vipw -s` pero NO se recomienda editarlo directamente

* `dateLastChange` Fecha del ultimo cambio expresado como numero de dias desde
1-1-1970.  
**Un valor de 0 indica que se debe cambiar en el siguiente login**  
*Un valor vacío significa que no se emplea nada sobre password aging*

* `minimumAge` Número de días que el usuario debe esperar antes de poder cambiar
su contraseña.  
*Un valor vacío, o 0, indican que no se emplea*

* `maximumAge` Número de días despues del cual el usuario debe cambiar la
contraseña. Una vez expirada, la contraseña puede seguir siendo válida (ver
`passwordInactivityPeriod`). Se pedirá cambiar contraseña en próximo login.  
**Un valor inferior a `minimumAge` indica que el usuario no puede cambiar la
contraseña**  
*Un valor vacío indica que no hay edad máxima, periodo de aviso ni
periodo de inactividad*

* `warningPeriod` Aviso para cambiar la contraseña antes de que expire.  
*Un valor vacío, o 0, indica que no se emplea*

* `inactivityPeriod` Numero de días despues de que la contraseña haya expirado
hasta deshabilitar la cuenta, por tanto durante los cuales la contraseña se
acepta y el usuario debe cambiarla en el siguiente login. Una vez que la
contraseña ha expirado y que el periodo de inactividad ha concluido, el usuario
no puede hacer login y debe contactar con el administrador  
*Un valor vacío, o 0, indica que no se emplea*

* `accountExpirationDate` Fecha en que ***una cuenta*** se deshabilita contado
en dias desde 1-1-1970. Cuando una cuenta se deshabilita, el usuario no puede
hacer login (cuando una *contraseña* expira, el usuario no puede hacer login
empleando su contraseña actual)  
*Un valor vacio significa que no se emplea. Un valor 0 no debe emplearse, porque
se puede interpretar como que no se emplea o que la cuenta expiró el 1-1-1970*

>

`/etc/group`

> Fichero de definición de grupos con el contenido (`man 5 group`),

> `groupname:password:GID:miembro1,miembro2,miembro3`

> Se puede editar con `vigr` pero NO se recomienda editarlo directamente

`/etc/gshadow`

> Fichero de contraseñas de los grupos con el contenido (`man 5 gshadow`),

> `groupname:encryptedPassword:admin1,admin2:member1,member2,member3`

> Se puede editar con `vigr -s` pero NO se recomienda editarlo directamente

>

### II. USERADD, USERMOD, USERDEL

`/etc/default/useradd`

> Valores por defecto para la creación de una cuenta (directorio home, fecha de
expiración de cuenta, dias desde password expirada hasta deshabilitar la cuenta,
grupo por defecto cuando se especifica, shell de la cuenta)

`useradd  -D`

> Muestra configuracion por defecto que se empleará para crear un usuario nuevo.
Incluido el parámetro `SKEL` de valor `/etc/skel/` y que contiene el conjunto
de ficheros inicial que se copiará al directorio *home* del nuevo usuario (por
ejemplo con `.bashrc, .vimrc,...`)

`useradd   [opciones]  usuario`

> Crea `usurio` con las siguientes opciones,

* `-s`  shell del usuario (`/sbin/nologin` para que no pueda iniciar sesión)
* `-u`  UID del usuario
* `-g`  GID del usuario
* `-G`  grupos secundarios del usuario
* `-d`  directorio `home` del usuario
* `-M`  no crear directorio *home*
* `-m`  crear directorio *home*
* `-o`  crear usuario con UID no único (user1-UID=1000, user2-UID=1000)
* `-e`  fecha en la que se deshabilita (o expira) la cuenta, NO la contraseña
* `-k`  directorio skeleton

`userdel  -r  -f  usuario`

> Borra usuario, incluido su directorio *home* (`-r`), y lo hace de manera
forzada (`-f`) aunque tenga sesión iniciada y haya ficheros en su *home* de otro
propietario. NO se recomienda cerrar así una cuenta, y en su lugar es preferible
matar todos los procesos (desconectarlo) y borrar su cuenta, así:

> `killall -9 -u usuario && userdel -r usuario`

`usermod  -a  -G  grupo1, grupo2  usuario`

> Modifica `usuario` para añadirlo (`-a`) a grupos (`-G`) `grupo1` y `grupo2`

`usermod  -L  usuario`

> Bloquea la cuenta de `usuario`

`usermod  -U  usuario`

> Desbloquea la cuenta de `usuario`

`echo "user1 user2 user3" | xargs  -n1  -t  useradd`

> Emplea el comando `xargs` para ejecutar el comando `useradd` sucesivas veces y
con un máximo de 1 argumento (`-n1`) leido de STDIN, mostrando los comandos
antes de su ejecución (`-t`)

>

### III. FICHEROS REFERENTES AL LOGIN DEL USUARIO [EX200]

`/etc/login.defs`

> Configuracion de *shadow password*, donde se definen todas las variables que
establecen los valores por defecto. Ver (`man 5 login.defs`), entre ellas,

> * `CREATE_HOME`  Si se debe crear un directorio HOME a los nuevos usuarios
> * `DEFAULT_HOME` Si se puede hacer login en caso de no poder cambiar a HOME
> * `ENCRYPT_METHOD` Algoritmo para cifrar la contraseña
> * `ENV_PATH` Variable `PATH` por defecto de los nuevos usuarios
> * `ENV_TZ` Timezone de los usuarios
> * `FAIL_DELAY` Retraso despues de un fallo antes de poder intentar otro login
> * `FAILLOG_ENAB` Registra fallos de login en `/var/log/faillog`
> * `FAKE_SHELL` Shell que se empleará en lugar del asignado en `/etc/passwd`
> * `ISSUE_FILE` Fichero que se mostrará antes de cada intento de login
> * `LOG_OK_LOGINS` Habilita el registro de los logins correctos
> * `LOG_UNKFAIL_ENAB` Registra intentos de login con usuarios desconocidos
> * `LOGIN_RETRIES` Maximo numero de reintentos en caso de contraseña incorrecta
> * `LOGIN_STRING` Prompt para preguntar la contraseña
> * `LOGIN_TIMEOUT` Tiempo máximo para realizar login
> * `MOTD_FILE` Ficheros con *motd* que se mostrarán al realizar login
> * `NOLOGIN_FAILS` Nombre de ficheros que si existen impiden login salvo `root`
> * `PASS_MAX_DAYS` Validez máxima de las contraseñas. Afecta al crear el user.
> * `PASS_MIN_DAYS` Validez mínima de las contraseñas. Afecta al crear el user.
> * `PASS_WARN` Dias de aviso antes de expirar contra. Afecta al crear el user.
> * `PASS_MIN_LEN` Longitud mínima de las contraseñas (NO SE EMPLEA)
> * `PASS_MAX_LEN` Longitud máxima de las contraseñas
> * `UID_MIN` UID mínimo para crear usuarios
> * `UID_MAX` UID máximo para crear usuarios
> * `UMASK` Mascara por defecto para crear ficheros (022)

`/etc/nologin`

> Si este fichero existe, solo podrá realizar login `root`. Al resto de usuarios
se les mostrará el contenido de este fichero (`man 5 nologin`)

`/etc/skel/`

> Directorio con ficheros que se copiarán al *home* de cada usuario nuevo

>

`/etc/security/pwquality.conf`

> Fichero de configuración de la calidad de las contraseñas, donde se establece
la longitud minima que deben tener (NO se hace en `login.defs`)

>

**User environment [EX200]**

Se leen y ejecutan los siguientes ficheros, persistiendo los cambios del último,

>

1. `/etc/profile`

> Fichero que se lee y ejecuta antes de cada *login shell*

2. `/etc/bashrc`

> Empleado en todos los subshell

>

3. `~/.bash_profile`

> Empleado en los *login shell* del usuario individual

4. `~/.bashrc`

> Empleado en cada subshell del usuario individual


