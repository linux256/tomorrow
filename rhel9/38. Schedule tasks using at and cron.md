\newpage

## DEPLOY CONFIGURE AND MAINTAIN SYSTEMS
# 38. Schedule tasks using at and cron

---

### I. SYSTEMD TIMERS

`man systemd.timer`

> Ayuda sobre los temporizadores en Systemd. Los *unit files* tienen sintáxis,

> `[Unit]`  
> `...`  
> `[Timer]`  
> **`AccuracySec`**  
> **`Persistent`**  
> **`OnActiveSec`**  
> **`OnBootSec`**  
> **`OnStartupSec`**  
> **`OnUnitActiveSec`**` # Tiempo desde inicio del servicio asociado al timer`  
> **`OnCalendar`**  
> `[Install]`  
> `Wantedby=timers.target`  

**`systemctl list-timers`**

> Lista los timers, que pueden estar en,

> * `/usr/lib/systemd/system/*.timer` Ruta de timers por defecto
> * `/etc/systemd/system/*.timer` Ruta de timers personalizados creados
> * `/run/systemd/system/*.timer` Ruta de timers en tiempo de ejecución

`systemctl list-units -t timer`  
`systemctl -t timer`  

> Lista los timers `loaded & active`. La opción `list-units` es por defecto

`systemctl --all -t timer`  
`systemctl --all *.timer`

> Lista todos los timers, en cualquier estado

`systemctl list-unit-files *.timer`

> Lista los *unit files* con nombre `*.timer` instalados en el sistema

>

### II. CRON & ANACRON

`man 5 crontab`

> Ayuda sobre el formato de ficheros de planificación de cron, con sintáxis,

> `minuto   hora   diaDelMes   mes       diaDeLaSemana   usuario   comando`  
> `0-59     0-23   1-31        1-12|str  0-7|string      str       str`  
> `*/5             1-5                   0=7=Sunday`

> El empleo de `*/5` significa cada 5 minutos, y `1-5` significa `1,2,3,4 y 5`. 
> *Si se especifica MES y DIADELASEMANA la programación es doble, se ejecuta en
ambas programaciones, similar a emplear lógica OR*

`/etc/crontab`

> Fichero de planificación genérico de tareas de cron

>

**COMO AGREGAR TAREAS PLANIFICADAS**

**Modo 1: ficheros personalizados para todo el sistema**

`/etc/cron.d/`

> Ubicación para ficheros de planificación personalizados

**Modo 2: ficheros personalizados en directorios con programación establecida**

`/etc/cron.hourly/                  /etc/cron.daily/`  
`/etc/cron.weekly/                  /etc/cron.monthly/`  

> Estas tareas se ejecutan con el comando **`anacron`** para tareas planificadas de
manera asíncrona (no necesariamente activo en el momento de su ejecución
planificada, sino que se ejecuta en el primer momento posible posterior a su
planificación). Emplea el fichero **`/etc/anacrontab`**

> *Como desactivar anacron. En `/etc/cron.hourly` se ubica el script `0anacron`
que invoca a `anacron -s` que emplea `/etc/anacrontab` y `cron.daily` etc...
Desactivando `0anacron` se interrumpe la cadena de tareas planificadas con
`anacron`. Para ello se puede crear el fichero `/etc/cron.hourly/jobs.deny` que
contenga la cadena `0anacron`*

**Modo 3: ficheros personalizados para cada usuario**

`crontab`

> Comando para editar fichero de planificación de un usuario

`/etc/cron.allow`

> Si existe solo los usuarios incluidos pueden usar `crontab`. Si está vacío
solo `root` puede usar `crontab`

`/etc/cron.deny`

> Si existe los usuarios no pueden usar `crontab` (incluir un usuario no elimina
trabajos ya existentes, solo impide futuros usos de `crontab`). Suele existir y
estar vacío => todos pueden usar `crontab`. **Solo debe existir cron.allow o
cron.deny. Si no existe ninguno solo `root` puede usar `crontab`. Si existen
ambos  prevalece `cron.allow`**

`/var/spool/cron/`

> Directorio de los ficheros de planificación de cada usuario (no editarlos)

`crontab -l`

> Lista los trabajos planificados por el usuario actual

`crontab -e`

> Edita los trabajos planificadas del usuario

`crontab -u user -e`

> Edita las tareas planificadas del usuario `user`

`crontab -r`

> Borra los trabajos planificados por el usuario actual

### III. EJECUCION DE TAREAS CON EL SERVICIO ATD Y BATCH

`dnf install at`  
`systemctl enable --now atd`  
`man atd`

> Con el servicio `atd` las tareas se programan para ejecuciones puntuales. Las
tareas programadas para fechas pasadas se ejecutarán tan pronto sea posible.

`at 14:00`  
`at 4pm + 3days`  
`at 1am tomorrow`  
`at 10am Jul 31`  

> Shell para editar comandos a ejecutar a las horas indicadas (salir CTRL-D)

`atq`

> Muestra cola de trabajos programados

`at -c 1`

> Muestra detalle del trabajo programado 1

`atrm 1`

> Elimina trabajo programado 1

`batch`

> Programa tareas con `atd` que solo serán ejecutadas si la carga del sistema
es inferior a 0.8 (valor por defecto). Se puede modificar el umbral de carga
con el parámetro `-l` en el inicio del servicio `atd`

### IV. ESPECIFICACION DE FECHAS AVANZADAS EN SYSTEMD Y EN CRON

`man systemd.time`

> Formato de fechas y horas, v.g. para **`OnCalendar`** de sección **`[Timer]`**

`systemd-analyze calendar '*-*~1' --iterations=12`

> Analiza una fecha calendarizada, mostrando el número de ocurrencias indicadas,
con la sintáxis,  

* `'*-*~1' --iterations=12` ...... último día del mes de los próximos 12 meses
* `'Mon 2025-01-08..14'` ...... segundo lunes de enero de 2025
* `'Mon 2025-01~1..7'` ...... último lunes de enero de 2025
* `'Mon 2025-01~07/1'` ...... último lunes de enero de 2025

**Tarea en cron, los lunes cada dos semanas**

> `min  hour  monthday  month  wkday  user  command`  
> `0    0     *         *      Mon    root  [ $(expr $(date +%V)%2) -eq 1 ]
> && comando`

> *Si la semana es impar (1, 3, 5,..) ejecuta el comando*  
> `date +%V` devuelve nº ISO de semana, la primera es la que tiene 4 o + días  
> `date +%W` devuelve nº de semana, la primera debe contener el primer lunes

### V. TIMER PARA UN SCRIPT, Y COMO HACERLO CON UN USUARIO [EX200]
```
1__/etc/systemd/system/hello.service__ó__~/.config/systemd/user/hello.service___
   [Unit]
   Description="Servicio para ejecutar la tarea que se quiere programar"
   [Service]
   ExecStart=/usr/local/bin/hello.sh            # o /home/bob/hello.sh

2__/etc/systemd/system/hello.timer__ó__~/.config/systemd/user/hello.timer_______
   [Unit]
   Description="Temporizador para ejecutar la tarea"
   [Timer]
   OnCalendar=Mon..Fri *-*-* 10:00:*            # lunes a viernes, a las 10:00
   OnBootSec=5min                               # 5' tras arrancar
   OnUnitActiveSec=24h                          # 24h tras ejecución del service
   Unit=hello.service
   [Install]
   WantedBy=multi-user.target

3__revisión_sintaxis____________________________________________________________
   systemd-analyze  verify  /etc/systemd/system/hello.*    ó   ~/.config/syst...

4__habilitar_e_iniciar_timer____________________________________________________
   systemctl enable --now   /etc/systemd/system/hello.timer
     ó
   loginctl enable-linger USUARIO               # iniciar con boot, no con login
   systemctl --user enable --now   ~/.config/systemd/user/hello.timer
```


